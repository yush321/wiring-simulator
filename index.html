<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    <title>ì „ê¸°ê¸°ëŠ¥ì‚¬ ë§ˆìŠ¤í„° (ìµœì¢…)</title>
    <style>
        body {
            font-family: 'Malgun Gothic', sans-serif;
            background-color: #333; color: white;
            display: flex; flex-direction: column; align-items: center;
            padding: 10px; margin: 0; overscroll-behavior: none; user-select: none;
        }
        h2 { margin: 10px 0; font-size: 1.2rem; text-align: center; color: #fff; }
        
        .controls { 
            margin-bottom: 10px; padding: 10px; background: #444;
            border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; align-items: center;
        }
        select { padding: 8px; font-weight: bold; border-radius: 4px; border: none; }
        button { 
            padding: 8px 15px; cursor: pointer; border: none; border-radius: 4px; 
            font-weight: bold; font-size: 14px; color: white; transition: 0.2s;
        }
        button:hover { filter: brightness(1.2); }
        .btn-reset { background-color: #6c757d; }
        .btn-check { background-color: #28a745; }
        .btn-undo { background-color: #ffc107; color: black; }
        .btn-check.active { background-color: #dc3545; }
        .btn-info { background-color: #17a2b8; }
        .btn-admin { background-color: #007bff; border: 1px solid #0056b3; }
        .btn-delete-all { background-color: #dc3545; border: 1px solid #a71d2a; font-size: 12px;}

        /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        /* íŒì—…ì°½(ëª¨ë‹¬)ê³¼ ê·¸ ë‚´ë¶€ ëª¨ë“  ìš”ì†Œì—ì„œ í™•ëŒ€ ì œìŠ¤ì²˜ í—ˆìš© */
        .info-modal, .modal-content, .modal-body {
            touch-action: manipulation !important; /* ë¸Œë¼ìš°ì € ê¸°ë³¸ ì œìŠ¤ì²˜(í™•ëŒ€) í—ˆìš© */
        }
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 1000; justify-content: center; align-items: center;
        }
        .modal-content {
            background: #fff; color: #333; width: 90%; max-width: 500px;
            padding: 25px; border-radius: 12px; position: relative;
            max-height: 85vh; overflow-y: auto; text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }
        .modal-header { font-size: 20px; font-weight: bold; margin-bottom: 15px; border-bottom: 2px solid #333; padding-bottom: 10px; }
        .modal-body img { max-width: 100%; height: auto; border: 1px solid #ccc; margin: 10px 0; border-radius: 5px;}
        .close-btn { position: absolute; top: 10px; right: 15px; font-size: 28px; cursor: pointer; font-weight: bold; color: #666; }
        .success-icon { font-size: 50px; margin-bottom: 10px; display: block; }

        #adminInfo { display: none; width: 90%; max-width: 700px; background: #222; border: 1px solid #555; padding: 15px; border-radius: 8px; margin-bottom: 10px; font-size: 14px; line-height: 1.6; }
        .info-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #444; padding-bottom: 10px; margin-bottom: 10px; }
        .key-badge { background: #555; padding: 2px 8px; border-radius: 4px; font-weight: bold; color: #fff; border: 1px solid #777; font-family: monospace; font-size: 16px; margin-right: 5px;}
        .mode-desc { display: flex; align-items: center; margin-bottom: 8px; }
        input[type="number"] { width: 50px; padding: 4px; text-align: center; background: #333; color: white; border: 1px solid #666; font-weight: bold; }
        #exportArea { width: 100%; height: 80px; margin-top: 10px; font-family: monospace; font-size: 12px; display: none; background: #111; color: #0f0; border: 1px solid #444; }

        canvas { background-color: #fff; border: 2px solid #555; box-shadow: 0 0 15px rgba(0,0,0,0.5); touch-action: none; max-width: 100%; height: auto; }
        .legend { font-size: 12px; color: #ccc; margin-top: 8px; display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;}
        .dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        #statusMsg { font-weight: bold; color: #fff; font-size: 14px; margin-left: 10px; }
    /* ëª¨ë‹¬ í•˜ë‹¨ ë²„íŠ¼ ì˜ì—­ */
    .modal-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 15px;
        gap: 10px;
    }
    .btn-page {
        flex: 1;
        background: #6c757d;
        color: white;
        padding: 10px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-weight: bold;
    }
    .btn-page:disabled { background: #ccc; cursor: not-allowed; }
    .btn-start { background: #007bff; }
    #pageIndicator { font-size: 14px; font-weight: bold; color: #666; }
    
        /* íŠœí† ë¦¬ì–¼ íŒì—… ë‚´ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    .modal-footer button {
        padding: 10px 20px;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        border: none;
        border-radius: 5px;
        transition: background 0.3s;
        margin: 0 5px;
    }

    /* [ì´ì „] ë²„íŠ¼: ì¡°ê¸ˆ ë” ì„ ëª…í•œ íšŒìƒ‰ ê³„ì—´ */
    #prevBtn {
        background-color: #6c757d;
        color: white;
    }
    #prevBtn:hover {
        background-color: #5a6268;
    }

    /* [ë‹¤ìŒ] ë²„íŠ¼: ì‹ ë¢°ê°ì„ ì£¼ëŠ” íŒŒë€ìƒ‰ (ê°€ì¥ ì˜ ë³´ì„) */
    #nextBtn {
        background-color: #007bff;
        color: white;
    }
    #nextBtn:hover {
        background-color: #0069d9;
    }

    /* [ì‹¤ìŠµ ì‹œì‘] ë²„íŠ¼: ê¸ì •ì ì¸ ì´ˆë¡ìƒ‰ */
    #startBtn {
        background-color: #28a745;
        color: white;
    }
    #startBtn:hover {
        background-color: #218838;
    }

    /* ë²„íŠ¼ì´ ë¹„í™œì„±í™”(disabled) ë˜ì—ˆì„ ë•Œ ìŠ¤íƒ€ì¼ */
    button:disabled {
        background-color: #e9ecef !important;
        color: #adb5bd !important;
        cursor: not-allowed;
    }

    /* í˜ì´ì§€ í‘œì‹œ ìˆ«ì (1/2) ìŠ¤íƒ€ì¼ */
    #pageIndicator {
        font-weight: bold;
        margin: 0 15px;
        color: #333;
    }
</style>
</head>
<body>

    <div id="infoModal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('infoModal')">&times;</span>
            <div class="modal-header" id="modalTitle">í•™ìŠµ ì•ˆë‚´</div>
            <div id="modalBody" class="modal-body"></div>
            
            <div class="modal-footer">
                <button id="prevBtn" onclick="changePage(-1)">ì´ì „</button>
                <span id="pageIndicator">1 / 1</span>
                <button id="nextBtn" onclick="changePage(1)">ë‹¤ìŒ</button>
                <button id="startBtn" class="btn-page btn-start" onclick="closeModal('infoModal')" style="display:none;">ì‹¤ìŠµ ì‹œì‘</button>
            </div>
        </div>
    </div>

    <div id="successModal" class="modal-overlay">
        <div class="modal-content" style="border-top: 5px solid #28a745;">
            <span class="close-btn" onclick="closeModal('successModal')">&times;</span>
            <div class="modal-body">
                <span class="success-icon">ğŸ‰</span>
                <h2 style="color:#28a745; margin:0;">ì •ë‹µì…ë‹ˆë‹¤!</h2>
                <p style="margin-top:10px; font-size:16px;">ì™„ë²½í•˜ê²Œ ê²°ì„ í•˜ì…¨ìŠµë‹ˆë‹¤.</p>
            </div>
            <button style="width:100%; margin-top:15px; background:#28a745; color:white; padding:12px; border:none; border-radius:5px; cursor:pointer; font-weight:bold; font-size:16px;" onclick="closeModal('successModal')">ê³„ì†í•˜ê¸°</button>
        </div>
    </div>

    <h2>ì „ê¸°ê¸°ëŠ¥ì‚¬ ë§ˆìŠ¤í„°</h2>
    
    <div class="controls">
        <select id="layoutSelect" onchange="changeLayout()"></select>
        <button class="btn-info" onclick="openModal()">ğŸ“– ì„¤ëª…</button>
        <button class="btn-undo" onclick="undoLastAction()">â†© (Ctrl+Z)</button>
        <button class="btn-reset" onclick="resetWires()">ì´ˆê¸°í™”</button>
        <button id="btnCheck" class="btn-check" onclick="toggleGrading()">ì±„ì  í•˜ê¸°</button>
        <div style="width: 1px; height: 20px; background: #666; margin: 0 5px;"></div>
        <button class="btn-admin" onclick="toggleAdminMode()">ğŸ”§ ê´€ë¦¬ì</button>
    </div>

    <div id="adminInfo">
        <div class="info-header">
            <span style="color:#00ffff;"><b>[ê´€ë¦¬ì: <span id="currentLayoutNum">1</span>ë²ˆ]</b></span>
            <div>
                <label>ê³µí†µ ì‹œì‘:</label> <input type="number" id="groupIndexInput" value="1" min="1">
                <button class="btn-delete-all" onclick="clearCurrentLayoutData()">ğŸ—‘ï¸ ì‚­ì œ</button>
            </div>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <div class="mode-desc" style="color: #ff6b6b;">
                <span class="key-badge">T</span> <div><b>ì •ë°€ ì±„ì </b><br><small>ì…ë ¥ í›„ T (ë¹¨ê°•)</small></div>
            </div>
            <div class="mode-desc" style="color: #4ecdc4;">
                <span class="key-badge">F</span> <div><b>ê³µí†µ ì±„ì </b><br><small>ì…ë ¥ í›„ F (ê·¸ë£¹ìƒ‰)</small></div>
            </div>
        </div>
        <div style="margin-top: 10px; padding-top:10px; border-top: 1px solid #444;">
             <button style="width:100%; background:#444;" onclick="exportAllData()">ğŸ“‹ ì „ì²´ ë°ì´í„° ìƒì„±</button>
        </div>
        <textarea id="exportArea" readonly></textarea>
        <div id="saveStatus" style="color: yellow; margin-top: 5px; height: 20px;"></div>
    </div>

    <div class="legend">
        <span><i class="dot" style="background:#e6b800"></i>ì‘ì—…ì„ </span>
        <span><i class="dot" style="background:#28a745"></i>ì •ë‹µ</span>
        <span><i class="dot" style="background:#dc3545"></i>ì˜¤ë‹µ</span>
    </div>
    <span id="statusMsg">ëŒ€ê¸° ì¤‘</span>
    
    <canvas id="simCanvas" width="700" height="720"></canvas>

<script>
    const DUCTS = { TOP: 100, MID: 320, BOT: 550, LEFT_X: 30, RIGHT_X: 670 };
    const GRID_H = 20;
    const PALETTE = ["#007bff", "#28a745", "#fd7e14", "#8B4513", "#6f42c1", "#17a2b8"];

    // ==========================================
    // 1. ê¸°ì´ˆ íŠœí† ë¦¬ì–¼ ì„¤ì •
    // ==========================================
    const TUTORIAL_CONFIG = {
        "t1": {
            title: "ê¸°ì´ˆ 1. ì£¼ì „ì› ì…/ì¶œë ¥",
            desc: ["ë‹¨ìëŒ€(TB)ì—ì„œ ì°¨ë‹¨ê¸°(MCCB) 1ì°¨ì¸¡ìœ¼ë¡œ<br>ì „ì›ì„ ì—°ê²°í•˜ëŠ” ê°€ì¥ ê¸°ì´ˆì ì¸ ì‘ì—…ì…ë‹ˆë‹¤.<br>íšŒë¡œë„ì˜  R(ê°ˆ), S(í‘), T(íšŒ)ìƒì„ í™•ì¸í•˜ê³  ì—°ê²°í•˜ì„¸ìš”.<br><br>" +
                  "MCCBì™€ EOCR ì‚¬ì´ì— í“¨ì¦ˆë„ ê²°ì„ ë˜ì–´ ìˆì–´ì„œ<br>í•œê³³ì— 2ì„ ì„ ë‚˜ì‚¬ ì–‘ìª½ì— í•˜ë‚˜ì”© ë„£ê³  ì²´ê²°í•˜ì‹œë©´ ë˜ìš”<br><br>" +
                  "ë…¹-í™©ìƒ‰ìœ¼ë¡œ ëœ ì ‘ì§€ì„ ì€ ë‹¤ ì—°ê²°í•´ì£¼ì‹œë©´ ë©ë‹ˆë‹¤<br>ì£¼ì˜í•´ì•¼ ë  ì ì€ FLSì— ì ‘ì§€ë„ ë¹¼ë¨¹ì§€ ë§ê³  ê°™ì´ í•˜ì…”ì•¼ ë˜ìš”<br><br>"],
            img: "./images/images1.png", 
            targetIds: ["TB_Top_L","TB_Top_R","MCCB", "EOCR","FUSE"] 
        },
        "t2": {
            title: "ê¸°ì´ˆ 2. MCCBì™€ FUSE,EOCR ì—°ê²°í•˜ê¸°",
            desc: ["MCCBì—ì„œ í“¨ì¦ˆ(FUSE)ë¥¼ ê±°ì³<br>EOCRì˜ ì „ì›ë¶€(6, 12ë²ˆ)ê¹Œì§€ ì—°ê²°í•˜ëŠ” ê³¼ì •ì…ë‹ˆë‹¤.<br>EOCRì˜ 1.2.3.7.8.9 ëŠ” ì£¼íšŒë¡œì ‘ì <br>6.12ì€ ì „ì›<br>4ëŠ” bì ‘ì , 5ëŠ” aì ‘ì , 10ë²ˆì€ C ê³µí†µì ì ì…ë‹ˆë‹¤"],
            img: "./images/images1.png",
            targetIds: ["MCCB", "FUSE", "EOCR"]
        },
        "t3": {
            title: "ê¸°ì´ˆ 3. EOCR í•€ë²ˆí˜¸ë³„ ë™ì‘ì´í•´í•˜ê³  FRê²°ì„ í•˜ê¸°",
            desc: ["ê³¼ì „ë¥˜ ë°œìƒ ì‹œ EOCRì€ Aì ‘ì ìœ¼ë¡œ ì „í™˜ë˜ë©°<br>FR(Flicker)ì´ ë™ì‘í•˜ì—¬ í™©ìƒ‰ë“±ê³¼ ë¶€ì €ê°€ êµëŒ€ë¡œ ë™ì‘í•©ë‹ˆë‹¤.<br>EOCR 5ë²ˆê³¼ FRì˜ ê³µí†µì ‘ì  8ë²ˆì„ ê²°ì„ í•˜ì„¸ìš”."],
            img: "./images/images1.png",
            targetIds: ["FR", "EOCR"]
        },
        "t4": {
            title: "ê¸°ì´ˆ 4. ë¦´ë ˆì´ì™€ íƒ€ì´ë¨¸",
            desc: [
                // --- 1í˜ì´ì§€ ì‹œì‘ ---
                "ğŸ’¡ <b>[ë¦´ë ˆì´ ì ‘ì  êµ¬ì¡° í™•ì¸]</b><br>" +
                "í˜„ì¬ ì‚¬ìš©ëœ 8í•€ ë¦´ë ˆì´ëŠ” <b>ê³µí†µ ì ‘ì ì´ ë‘ ê°œ</b>ì¸ ë‚´ë¶€ êµ¬ì¡°ë¥¼ ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤.<br>" +
                "ì§€ê¸ˆ ë³´ì´ëŠ” íšŒë¡œëŠ” ë¦´ë ˆì´ ë‘ ê°œê°€ ì—°ê²°ë˜ì–´ ìˆì–´ <b>ê³µí†µì„ í•˜ë‚˜ë¡œ ì”ë‹ˆë‹¤.</b><br><br>" +
                "ğŸ”µ <b>[ë¦´ë ˆì´ ì—°ê²°]</b><br>" +
                "â€¢ <b style='color:#007bff;'>1ë²ˆ (ê³µí†µ)</b> ë‹¨ìë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì—°ê²°í•©ë‹ˆë‹¤.<br>" +
                "â€¢ <b>Aì ‘ì </b> ì‚¬ìš© ì‹œ: <b style='color:#28a745;'>3ë²ˆ</b> ì—°ê²°<br>" +
                "â€¢ <b>Bì ‘ì </b> ì‚¬ìš© ì‹œ: <b style='color:#dc3545;'>4ë²ˆ</b> ì—°ê²°<br><br>" +
                "â±ï¸ <b>[íƒ€ì´ë¨¸ ì—°ê²°]</b><br>" +
                "â€¢ <b>ìˆœì‹œ Aì ‘ì </b>: <b style='color:#007bff;'>1ë²ˆ - 3ë²ˆ</b> ì‚¬ìš©<br>" +
                "â€¢ <b>í•œì‹œ Aì ‘ì </b>: <b style='color:#dc3545;'>8ë²ˆ - 6ë²ˆ</b> ì‚¬ìš©", // <-- 1. ë”°ì˜´í‘œ ë‹«ê³  2. ì‰¼í‘œ ì°ê¸°!

                // --- 2í˜ì´ì§€ ì‹œì‘ (ì‰¼í‘œ ë’¤ì— ìƒˆë¡œ ì‹œì‘!) ---
                "ğŸ”„ <b>[íšŒë¡œ ë™ì‘ ìˆœì„œ]</b><br>" +
                "1ï¸âƒ£ <b>PB1</b> ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ <b>íƒ€ì´ë¨¸</b>ì™€ <b>MC1</b>ì´ ì‘ë™í•©ë‹ˆë‹¤.<br>" +
                "2ï¸âƒ£ ì„¤ì •ëœ ì‹œê°„ì´ ì§€ë‚˜ë©´ <b>MC1</b>ì€ ì •ì§€í•˜ê³ , <b>MC2</b>ê°€ ë™ì‘í•©ë‹ˆë‹¤.<br><br>" +
                "<div style='border: 2px dashed #007bff; background-color: #f8f9fa; padding: 15px; border-radius: 10px;'>" +
                "   <b>ğŸ“ [ì‹¤ìŠµ] ì•„ë˜ ë‹¨ìë“¤ì„ ì—°ê²°í•˜ì„¸ìš”!</b><br>" +
                "   ë¦´ë ˆì´ 1ë²ˆ, PB1 O(open), íƒ€ì´ë¨¸ 1ë²ˆ, MC1 6ë²ˆ, íƒ€ì´ë¨¸ 8ë²ˆ<br>" +
                "   <div style='display: flex; gap: 10px; margin-top: 10px;'>" + 
                "       <img src='./images/images1.png' style='width: 48%;'>" +
                "       <img src='./images/images2.png' style='width: 48%;'>" +
                "   </div>" +
                "</div>"
            ],
            targetIds: ["X", "T", "MC1", "TB_Top_L"]
        }
    }
        // 2. í˜ì´ì§€ ì œì–´ ë³€ìˆ˜ ë° í•¨ìˆ˜
    let currentModalPage = 0;

    function openModal() {
        currentModalPage = 0; // ì‹œì‘í•  ë•Œ ë¬´ì¡°ê±´ 0ë²ˆ í˜ì´ì§€ë¡œ ë¦¬ì…‹
        updateModalContent();
        document.getElementById('infoModal').style.display = "flex";
    }

    function updateModalContent() {
        const data = TUTORIAL_CONFIG[currentLayoutId];
        if (!data) return;

        // [ì¤‘ìš”] descê°€ ë°°ì—´ì´ ì•„ë‹ˆë©´ ë°°ì—´ë¡œ ë§Œë“¤ì–´ì„œ ë¬´ì¡°ê±´ 'ë¦¬ìŠ¤íŠ¸'ë¡œ ì·¨ê¸‰í•¨
        const pages = Array.isArray(data.desc) ? data.desc : [data.desc];

        // í˜„ì¬ í˜ì´ì§€ ë‚´ìš© ì¶œë ¥
        const modalBody = document.getElementById('modalBody');
        modalBody.innerHTML = pages[currentModalPage];

        // ì œëª© ë° í˜ì´ì§€ ë²ˆí˜¸ í‘œì‹œ (1/3 ë“±)
        const modalTitle = document.getElementById('modalTitle');
        const indicator = document.getElementById('pageIndicator');
        
        if (pages.length > 1) {
            modalTitle.innerText = `${data.title} (${currentModalPage + 1}/${pages.length})`;
            indicator.innerText = `${currentModalPage + 1} / ${pages.length}`;
            indicator.style.display = "inline-block";
        } else {
            modalTitle.innerText = data.title;
            indicator.style.display = "none";
        }

        // ë²„íŠ¼ ì œì–´ ë¡œì§ (í˜ì´ì§€ ìˆ˜ì— ë”°ë¼ ìë™ ì¡°ì ˆ)
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const startBtn = document.getElementById('startBtn');

        // 1í˜ì´ì§€ë¿ì¼ ë•Œ
        if (pages.length <= 1) {
            prevBtn.style.display = "none";
            nextBtn.style.display = "none";
            startBtn.style.display = "inline-block";
        } else {
            // ë‹¤ì¤‘ í˜ì´ì§€ì¼ ë•Œ
            prevBtn.style.display = (currentModalPage === 0) ? "none" : "inline-block";
            prevBtn.disabled = (currentModalPage === 0);

            if (currentModalPage === pages.length - 1) {
                nextBtn.style.display = "none";
                startBtn.style.display = "inline-block";
            } else {
                nextBtn.style.display = "inline-block";
                startBtn.style.display = "none";
            }
        }
    }

    // ì´ì „/ë‹¤ìŒ ë²„íŠ¼ ê³µìš© í•¨ìˆ˜
    function changePage(direction) {
        const data = TUTORIAL_CONFIG[currentLayoutId];
        const pages = Array.isArray(data.desc) ? data.desc : [data.desc];
        
        currentModalPage += direction;
        
        // ë²”ìœ„ë¥¼ ë²—ì–´ë‚˜ì§€ ì•Šê²Œ ì²´í¬
        if (currentModalPage < 0) currentModalPage = 0;
        if (currentModalPage >= pages.length) currentModalPage = pages.length - 1;

        updateModalContent();
    }
    const PUBLIC_LAYOUT_BASE = [
        { id: 'TB_Top_L', label: '', x: 50, y: 30, w: 280, h: 50, type: 'terminal', startNum: 1, pins: [ {n:'C', g:'PB01'}, {n:'N', g:'PB01'}, {n:'O', g:'PB01'}, {n:'M', g:'SS'}, {n:'C', g:'SS'}, {n:'A', g:'SS'}, {n:'$', g:'$'}, {n:'$', g:'$'}, {n:'ê°ˆ', g:'TB1'}, {n:'í‘', g:'TB1'} ] },
        { id: 'TB_Top_R', label: '', x: 370, y: 30, w: 280, h: 50, type: 'terminal', startNum: 11, pins: [ {n:'íšŒ', g:'TB1'}, {n:'ë…¹', g:'TB1'}, {n:'$', g:'$'}, {n:'$', g:'$'}, {n:'$', g:'$'}, {n:'$', g:'$'}, {n:'$', g:'$'}, {n:'+', g:'RLGL'}, {n:'-', g:'RLGL'}, {n:'+', g:'RLGL'} ] },
        { id: 'FUSE', label: 'FUSE', x: 50, y: 160, w: 60, h: 110, type: 'fuse', topArr: [ {n:'+1', l:''}, {n:'-1', l:''} ], botArr: [ {n:'+2', l:''}, {n:'-2', l:''} ] },
        { id: 'EOCR', label: 'EOCR', x: 130, y: 160, w: 90, h: 110, type: 'custom', topArr: [ {n:'1',l:'a'}, {n:'2',l:'a'}, {n:'3',l:'a'}, {n:'4',l:'b'}, {n:'5',l:'a'}, {n:'6',l:'ì „'} ], botArr: [ {n:'7',l:'a'}, {n:'8',l:'a'}, {n:'9',l:'a'}, {n:'10',l:'c'}, {n:'$',l:'$'}, {n:'12',l:'ì›'} ] },
        { id: 'MCCB', label: 'MCCB', x: 240, y: 160, w: 80, h: 110, type: 'custom', topArr: [ {n:'1',l:''}, {n:'2',l:''}, {n:'3',l:''} ], botArr: [ {n:'7',l:''}, {n:'8',l:''}, {n:'9',l:''} ] },
        { id: 'X', label: 'X (8P)', x: 340, y: 160, w: 90, h: 110, type: 'custom', topArr: [ {n:'6',l:'A'}, {n:'5',l:'B'}, {n:'4',l:'b'}, {n:'3',l:'a'} ], botArr: [ {n:'7',l:'ì „'}, {n:'8',l:'C'}, {n:'1',l:'C'}, {n:'2',l:'ì›'} ] },
        { id: 'FR', label: 'FR (8P)', x: 450, y: 160, w: 90, h: 110, type: 'custom', topArr: [ {n:'6',l:'a'}, {n:'5',l:'b'}, {n:'$',l:'$'}, {n:'$',l:'$'} ], botArr: [ {n:'7',l:'ì „'}, {n:'8',l:'C'}, {n:'$',l:'$'}, {n:'2',l:'ì›'} ] },
        { id: 'T', label: 'Timer', x: 80, y: 390, w: 90, h: 110, type: 'custom', topArr: [ {n:'6',l:'A'}, {n:'5',l:'B'}, {n:'$',l:'$'}, {n:'3',l:'a'} ], botArr: [ {n:'7',l:'ì „'}, {n:'8',l:'C'}, {n:'1',l:'a'}, {n:'2',l:'ì›'} ] },
        { id: 'FLS', label: 'FLS', x: 190, y: 390, w: 90, h: 110, type: 'custom', topArr: [ {n:'6',l:'ì „'}, {n:'5',l:'C'}, {n:'4',l:'a'}, {n:'3',l:'ì›'} ], botArr: [ {n:'7',l:'E1'}, {n:'8',l:'E2'}, {n:'1',l:'E3'}, {n:'2',l:'b'} ] },
        { id: 'MC1', label: 'MC1', x: 300, y: 390, w: 100, h: 110, type: 'custom', topArr: [ {n:'1',l:'a'}, {n:'2',l:'a'}, {n:'3',l:'a'}, {n:'4',l:'a'}, {n:'5',l:'b'}, {n:'6',l:'ì „'} ], botArr: [ {n:'7',l:'a'}, {n:'8',l:'a'}, {n:'9',l:'a'}, {n:'10',l:'a'}, {n:'11',l:'b'}, {n:'12',l:'ì›'} ] },
        { id: 'MC2', label: 'MC2', x: 420, y: 390, w: 100, h: 110, type: 'custom', topArr: [ {n:'1',l:'a'}, {n:'2',l:'a'}, {n:'3',l:'a'}, {n:'4',l:'a'}, {n:'5',l:'b'}, {n:'6',l:'ì „'} ], botArr: [ {n:'7',l:'a'}, {n:'8',l:'a'}, {n:'9',l:'a'}, {n:'10',l:'a'}, {n:'11',l:'b'}, {n:'12',l:'ì›'} ] },
        { id: 'TB_Bot_L', label: '', x: 50, y: 600, w: 280, h: 50, type: 'terminal', startNum: 1, pins: [ {n:'Y', g:'YLBZ'}, {n:'C', g:'YLBZ'}, {n:'B', g:'YLBZ'}, {n:'$', g:'$'}, {n:'$', g:'$'}, {n:'$', g:'$'}, {n:'ê°ˆ', g:'TB3'}, {n:'í‘', g:'TB3'}, {n:'íšŒ', g:'TB3'}, {n:'ë…¹', g:'TB3'} ] },
        { id: 'TB_Bot_R', label: '', x: 370, y: 600, w: 280, h: 50, type: 'terminal', startNum: 11, pins: [ {n:'E1', g:'TB4'}, {n:'E2', g:'TB4'}, {n:'E3', g:'TB4'}, {n:'$', g:'$'}, {n:'$', g:'$'}, {n:'$', g:'$'}, {n:'ê°ˆ', g:'TB2'}, {n:'í‘', g:'TB2'}, {n:'íšŒ', g:'TB2'}, {n:'ë…¹', g:'TB2'} ] }
    ];

    // ==========================================
    // 2. ì •ë‹µ ë°ì´í„° (ë®ì–´ì”Œìš°ëŠ” ê³³)
    // ==========================================
let DB_ANSWERS = {
    "1": {
        "targets": [],
        "commons": []
    },
    "2": {
        "targets": [],
        "commons": []
    },
    "3": {
        "targets": [],
        "commons": []
    },
    "4": {
        "targets": [],
        "commons": []
    },
    "5": {
        "targets": [],
        "commons": []
    },
    "6": {
        "targets": [],
        "commons": []
    },
    "7": {
        "targets": [],
        "commons": []
    },
    "8": {
        "targets": [],
        "commons": []
    },
    "9": {
        "targets": [],
        "commons": []
    },
    "10": {
        "targets": [],
        "commons": []
    },
    "11": {
        "targets": [],
        "commons": []
    },
    "12": {
        "targets": [],
        "commons": []
    },
    "13": {
        "targets": [],
        "commons": []
    },
    "14": {
        "targets": [],
        "commons": []
    },
    "15": {
        "targets": [],
        "commons": []
    },
    "16": {
        "targets": [],
        "commons": []
    },
    "17": {
        "targets": [],
        "commons": []
    },
    "18": {
        "targets": [],
        "commons": []
    },
    "t1": {
        "targets": [
            [
                "TB_Top_L_9",
                "MCCB_1",
                3.4422955218189877
            ],
            [
                "TB_Top_L_10",
                "MCCB_2",
                14.402744121662579
            ],
            [
                "TB_Top_R_11",
                "MCCB_3",
                7.703092033211433
            ],
            [
                "MCCB_7",
                "EOCR_1",
                -13.195863232590252
            ],
            [
                "MCCB_8",
                "EOCR_2",
                -6.1723225534668025
            ],
            [
                "MCCB_9",
                "EOCR_3",
                6.67968387912223
            ]
        ],
        "commons": []
    },
    "t2": {
        "targets": [
            [
                "MCCB_7",
                "FUSE_+1",
                11.961592880907784
            ],
            [
                "FUSE_+1",
                "EOCR_1",
                -3.3590055420456046
            ],
            [
                "MCCB_8",
                "EOCR_2",
                9.260988887519005
            ],
            [
                "MCCB_9",
                "FUSE_-1",
                9.660721395085677
            ],
            [
                "FUSE_-1",
                "EOCR_3",
                -12.992623871979376
            ]
        ],
        "commons": []
    },
    "t3": {
        "targets": [
            [
                "EOCR_5",
                "FR_8",
                7.944782219933767
            ]
        ],
        "commons": []
    },
    "t4": {
        "targets": [],
        "commons": []
    }
};
    // ==========================================
    // 3. ë³€ìˆ˜ ë° ì´ˆê¸°í™”
    // ==========================================
    const canvas = document.getElementById('simCanvas');
    const ctx = canvas.getContext('2d');
    const statusMsg = document.getElementById('statusMsg');
    const btnCheck = document.getElementById('btnCheck');
    const adminInfo = document.getElementById('adminInfo');
    const saveStatus = document.getElementById('saveStatus');
    const groupIndexInput = document.getElementById('groupIndexInput');
    const exportArea = document.getElementById('exportArea');
    const layoutSelect = document.getElementById('layoutSelect');
    const currentLayoutNumSpan = document.getElementById('currentLayoutNum');
    
    const infoModal = document.getElementById('infoModal');
    const successModal = document.getElementById('successModal');
    const modalTitle = document.getElementById('modalTitle');
    const modalBody = document.getElementById('modalBody');

    let currentLayoutId = "t1"; 
    let currentComponents = [];
    let allPins = [], wires = [], historyStack = [];
    let selectedPin = null; 
    let isGradingMode = false;
    let isAdminMode = false; 
    let focusedGroup = null; 

    function init() {
        const grp1 = document.createElement('optgroup'); grp1.label = "--- ê¸°ì´ˆ íŠœí† ë¦¬ì–¼ ---";
        for(let k in TUTORIAL_CONFIG) {
            const opt = document.createElement('option'); opt.value = k; opt.innerText = TUTORIAL_CONFIG[k].title;
            grp1.appendChild(opt);
        }
        layoutSelect.appendChild(grp1);

        const grp2 = document.createElement('optgroup'); grp2.label = "--- ì‹¤ì „ ì—°ìŠµ ---";
        for(let i=1; i<=18; i++) {
            const opt = document.createElement('option'); opt.value = i; opt.innerText = `ê³µê°œë„ë©´ ${i}ë²ˆ`;
            grp2.appendChild(opt);
        }
        layoutSelect.appendChild(grp2);

        document.addEventListener('keydown', handleKeyInput);
        canvas.addEventListener('mousedown', (e) => handleInput(e.clientX, e.clientY));
        canvas.addEventListener('touchstart', (e) => { e.preventDefault(); handleInput(e.touches[0].clientX, e.touches[0].clientY); }, { passive: false });
        
        changeLayout();
    }

    function changeLayout() {
        currentLayoutId = layoutSelect.value;
        currentLayoutNumSpan.innerText = currentLayoutId;
        
        if (TUTORIAL_CONFIG[currentLayoutId]) {
            const targetIds = TUTORIAL_CONFIG[currentLayoutId].targetIds;
            currentComponents = PUBLIC_LAYOUT_BASE.filter(comp => targetIds.includes(comp.id));
            currentComponents = JSON.parse(JSON.stringify(currentComponents));
            openModal();
        } else {
            currentComponents = JSON.parse(JSON.stringify(PUBLIC_LAYOUT_BASE));
        }
        
        allPins = [];
        currentComponents.forEach(comp => generatePins(comp));
        resetWires();
        statusMsg.textContent = `${currentLayoutId} ì¤€ë¹„ì™„ë£Œ`;
    }

    function openModal() {
    // 1. í˜„ì¬ í™”ë©´ì— í‘œì‹œëœ ë ˆì´ì•„ì›ƒ IDë¥¼ ë‹¤ì‹œ í•œ ë²ˆ ì •í™•íˆ ê°€ì ¸ì˜µë‹ˆë‹¤.
    // (ë³´í†µ ì™¼ìª½ ë©”ë‰´ë‚˜ ì„¤ì •ì—ì„œ ì„ íƒëœ ë ˆì´ì•„ì›ƒ ë²ˆí˜¸)
    currentLayoutId = document.getElementById('layoutSelect')?.value || currentLayoutId;

    // 2. í˜ì´ì§€ ë²ˆí˜¸ë¥¼ 0(1í˜ì´ì§€)ìœ¼ë¡œ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.
    currentModalPage = 0; 
    
    // 3. ë°ì´í„°ë¥¼ ê°€ì ¸ì™€ì„œ í™”ë©´ì„ ê·¸ë¦½ë‹ˆë‹¤.
    const data = TUTORIAL_CONFIG[currentLayoutId];
    
    if (data) {
        // [ì¤‘ìš”] ë‚´ìš©ì„ ê·¸ë¦¬ê¸° ì „ì— ê¸°ì¡´ì— ë‚¨ì•˜ë˜ í”ì ì„ ê¹¨ë—ì´ ë¹„ì›ë‹ˆë‹¤.
        document.getElementById('modalBody').innerHTML = ""; 
        updateModalContent();
        document.getElementById('infoModal').style.display = "flex";
    } else {
        // ì‹¤ì „ ëª¨ë“œ ì²˜ë¦¬...
        modalTitle.innerText = `ê³µê°œë„ë©´ ${currentLayoutId}ë²ˆ`;
        modalBody.innerHTML = `<p>ì‹¤ì „ ë¬¸ì œì…ë‹ˆë‹¤. ì „ì²´ íšŒë¡œë¥¼ êµ¬ì„±í•˜ì„¸ìš”.</p>`;
        document.getElementById('prevBtn').style.display = "none";
        document.getElementById('nextBtn').style.display = "none";
        document.getElementById('pageIndicator').style.display = "none";
        document.getElementById('startBtn').style.display = "inline-block";
        document.getElementById('infoModal').style.display = "flex";
    }
}
    function closeModal(id) { document.getElementById(id).style.display = "none"; }

    function generatePins(comp) {
        const topY = comp.y; const botY = comp.y + comp.h;
        if (comp.type === 'terminal') {
            const gap = comp.w / 10;
            comp.pins.forEach((p, i) => {
                if (p.n !== '$') {
                    let pinY = (comp.y < 300) ? botY : topY;
                    addPin(comp, comp.startNum + i, p.n, comp.x + gap/2 + i*gap, pinY);
                }
            });
        } else {
            if(comp.topArr) {
                const gap = comp.w / comp.topArr.length;
                comp.topArr.forEach((item, idx) => { if(item.n !== '$') addPin(comp, item.n, item.l, comp.x + gap/2 + idx*gap, topY); });
            }
            if(comp.botArr) {
                const gap = comp.w / comp.botArr.length;
                comp.botArr.forEach((item, idx) => { if(item.n !== '$') addPin(comp, item.n, item.l, comp.x + gap/2 + idx*gap, botY); });
            }
        }
    }

    function addPin(comp, pinNum, label, x, y) {
        allPins.push({ id: `${comp.id}_${pinNum}`, parentId: comp.id, num: pinNum, label: label, x: x, y: y, connections: 0 });
    }

    function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        if (!TUTORIAL_CONFIG[currentLayoutId]) {
            ctx.beginPath(); ctx.strokeStyle = '#eee'; ctx.lineWidth = 10;
            [DUCTS.TOP, DUCTS.MID, DUCTS.BOT].forEach(y => { ctx.moveTo(0, y); ctx.lineTo(canvas.width, y); });
            ctx.moveTo(DUCTS.LEFT_X, 0); ctx.lineTo(DUCTS.LEFT_X, canvas.height);
            ctx.moveTo(DUCTS.RIGHT_X, 0); ctx.lineTo(DUCTS.RIGHT_X, canvas.height);
            ctx.stroke();
        }

        const ans = DB_ANSWERS[currentLayoutId];

        if (isAdminMode && ans) {
            ans.targets.forEach(info => {
                const s = allPins.find(p => p.id === info[0]); const e = allPins.find(p => p.id === info[1]);
                if (s && e) drawDuctWire(s, e, info[2], '#dc3545', 2);
            });
            ans.commons.forEach(group => {
                if (group.visuals) {
                    group.visuals.forEach(info => {
                        const s = allPins.find(p => p.id === info[0]); const e = allPins.find(p => p.id === info[1]);
                        if (s && e) drawDuctWire(s, e, info[2], group.color, 2);
                    });
                }
            });
        }

        if (isGradingMode && focusedGroup) {
            if (focusedGroup.type === 'target') {
                const s = allPins.find(p => p.id === focusedGroup.data[0]);
                const e = allPins.find(p => p.id === focusedGroup.data[1]);
                if(s && e) { ctx.setLineDash([5, 5]); drawDuctWire(s, e, focusedGroup.data[2], '#00ff00', 2); ctx.setLineDash([]); }
            } 
            else if (focusedGroup.type === 'common') {
                if(focusedGroup.data.visuals) {
                    ctx.setLineDash([5, 5]);
                    focusedGroup.data.visuals.forEach(v => {
                        const s = allPins.find(p => p.id === v[0]); const e = allPins.find(p => p.id === v[1]);
                        if(s && e) drawDuctWire(s, e, v[2], focusedGroup.data.color, 2);
                    });
                    ctx.setLineDash([]);
                }
            }
        }

        wires.forEach(w => {
            let color = '#e6b800'; 
            let alpha = 1.0;
            if (isGradingMode) {
                if (focusedGroup) {
                    if (w.matchedGroup !== focusedGroup.data) { alpha = 0.1; color = '#ccc'; } 
                    else { color = w.gradingColor; }
                } else { if (w.gradingColor) color = w.gradingColor; }
            }
            ctx.globalAlpha = alpha;
            drawDuctWire(w.start, w.end, w.offset, color, 3);
            ctx.globalAlpha = 1.0;
        });

        currentComponents.forEach(c => {
            ctx.fillStyle = '#fff'; ctx.fillRect(c.x, c.y, c.w, c.h);
            ctx.strokeStyle = '#333'; ctx.lineWidth = 2; ctx.strokeRect(c.x, c.y, c.w, c.h);
            ctx.fillStyle = '#000'; ctx.font = 'bold 14px Arial'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
            if (c.type !== 'terminal') ctx.fillText(c.label, c.x + c.w/2, c.y + c.h/2);

            if (c.type === 'terminal') {
                const gap = c.w / 10;
                ctx.beginPath(); ctx.moveTo(c.x, c.y + c.h/2); ctx.lineTo(c.x + c.w, c.y + c.h/2); ctx.stroke();
                c.pins.forEach((p, i) => {
                    const cellX = c.x + i*gap;
                    if (i > 0) { ctx.beginPath(); ctx.moveTo(cellX, c.y); ctx.lineTo(cellX, c.y + c.h); ctx.stroke(); }
                    if (p.n !== '$') {
                        ctx.fillStyle='#d9534f'; ctx.font='10px Arial'; ctx.fillText(p.g, cellX+gap/2, c.y+c.h/4);
                        ctx.fillStyle='#000'; ctx.font='11px Arial'; ctx.fillText(p.n, cellX+gap/2, c.y+(c.h*3)/4);
                        ctx.fillStyle='#007bff'; ctx.font='10px Arial'; 
                        if(c.y<300) ctx.fillText(c.startNum+i, cellX+gap/2, c.y-8); else ctx.fillText(c.startNum+i, cellX+gap/2, c.y+c.h+10);
                    }
                });
            } else {
                if(c.topArr) {
                    const gap = c.w / c.topArr.length;
                    c.topArr.forEach((item, i) => {
                        const cellX = c.x + gap * i;
                        ctx.beginPath(); ctx.rect(cellX, c.y, gap, GRID_H*2); ctx.stroke();
                        if(item.n!=='$') { ctx.fillStyle='#000'; ctx.font='12px Arial'; ctx.fillText(item.n, cellX+gap/2, c.y+GRID_H/2); if(item.l) { ctx.fillStyle='blue'; ctx.font='11px Arial'; ctx.fillText(item.l, cellX+gap/2, c.y+GRID_H*1.5); } }
                    });
                }
                if(c.botArr) {
                    const yBase = c.y + c.h;
                    const gap = c.w / c.botArr.length;
                    c.botArr.forEach((item, i) => {
                        const cellX = c.x + gap * i;
                        ctx.beginPath(); ctx.rect(cellX, yBase-GRID_H*2, gap, GRID_H*2); ctx.stroke();
                        if(item.n!=='$') { ctx.fillStyle='#000'; ctx.font='12px Arial'; ctx.fillText(item.n, cellX+gap/2, yBase-GRID_H/2); if(item.l) { ctx.fillStyle='blue'; ctx.font='11px Arial'; ctx.fillText(item.l, cellX+gap/2, yBase-GRID_H*1.5); } }
                    });
                }
            }
        });

        allPins.forEach(p => {
            ctx.beginPath(); ctx.arc(p.x, p.y, 6, 0, Math.PI*2);
            let fill = (p === selectedPin) ? '#ff0000' : (p.connections>=2 ? '#333' : '#fff');
            if (isAdminMode && ans) { ans.commons.forEach(g => { if (g.pins.includes(p.id)) fill = g.color; }); }
            ctx.fillStyle = fill; ctx.strokeStyle = '#007bff'; ctx.lineWidth = 2; ctx.fill(); ctx.stroke();
        });
    }

    function drawDuctWire(start, end, offset, color, width) {
        ctx.beginPath(); ctx.strokeStyle = color; ctx.lineWidth = width; ctx.lineJoin = 'round';
        let startDuctY = getNearestDuctY(start.y); let endDuctY = getNearestDuctY(end.y);
        
        // íŠœí† ë¦¬ì–¼ì´ë©´ ë‹¨ìˆœ ì—°ê²° (ì˜µì…˜)
        if(TUTORIAL_CONFIG[currentLayoutId]) {
             // í•„ìš”ì‹œ ë•íŠ¸ ë¬´ì‹œ ë¡œì§ ì¶”ê°€
        }

        const sy = startDuctY + offset; const ey = endDuctY + offset;
        ctx.moveTo(start.x, start.y);
        if (startDuctY === endDuctY) { ctx.lineTo(start.x, sy); ctx.lineTo(end.x, sy); ctx.lineTo(end.x, end.y); } 
        else {
            const midX = (start.x + end.x) / 2;
            const sideX = (midX < 350) ? DUCTS.LEFT_X : DUCTS.RIGHT_X;
            const sx = sideX + (sideX === DUCTS.LEFT_X ? -offset : offset); 
            ctx.lineTo(start.x, sy); ctx.lineTo(sx, sy); ctx.lineTo(sx, ey); ctx.lineTo(end.x, ey); ctx.lineTo(end.x, end.y);
        }
        ctx.stroke();
    }
    
    function getNearestDuctY(y) {
        const dists = [ { val: DUCTS.TOP, dist: Math.abs(y - DUCTS.TOP) }, { val: DUCTS.MID, dist: Math.abs(y - DUCTS.MID) }, { val: DUCTS.BOT, dist: Math.abs(y - DUCTS.BOT) } ];
        dists.sort((a, b) => a.dist - b.dist);
        return dists[0].val;
    }

    // ==========================================
    // ê´€ë¦¬ì, ì…ë ¥, ì±„ì  ë¡œì§
    // ==========================================
    function toggleAdminMode() {
        isAdminMode = !isAdminMode;
        if(isAdminMode) {
            adminInfo.style.display = 'block';
            statusMsg.textContent = `[ê´€ë¦¬ì] ${currentLayoutId} ì‘ì—… ì¤‘`;
            statusMsg.style.color = "#007bff";
            wires = []; draw();
        } else {
            adminInfo.style.display = 'none';
            statusMsg.textContent = "ëŒ€ê¸° ì¤‘";
            statusMsg.style.color = "#fff";
            wires = []; draw();
        }
    }

    function handleKeyInput(e) {
        if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'z') { e.preventDefault(); undoLastAction(); return; }
        if (isAdminMode) {
            const key = e.key.toLowerCase();
            const currentAnswers = DB_ANSWERS[currentLayoutId]; 
            if (key === 't') {
                if (wires.length === 0) return alert("ì„  ì—†ìŒ");
                wires.forEach(w => currentAnswers.targets.push([w.start.id, w.end.id, w.offset]));
                showSaveStatus(`${currentLayoutId}: ì •ë°€(ë¹¨ê°•) ì €ì¥ë¨!`); wires = []; draw(); 
            }
            else if (key === 'f') {
                if (wires.length === 0) return alert("ì„  ì—†ìŒ");
                const pinSet = new Set(); const visualWires = []; 
                wires.forEach(w => { pinSet.add(w.start.id); pinSet.add(w.end.id); visualWires.push([w.start.id, w.end.id, w.offset]); });
                const groupNum = parseInt(groupIndexInput.value);
                const color = PALETTE[(groupNum - 1) % PALETTE.length]; 
                currentAnswers.commons.push({ name: groupNum.toString(), color: color, pins: Array.from(pinSet), visuals: visualWires });
                showSaveStatus(`${currentLayoutId}: ê³µí†µ ${groupNum}ë²ˆ ì €ì¥ë¨!`);
                groupIndexInput.value = groupNum + 1; wires = []; draw(); 
            }
        }
    }

    function calculateGrading() {
        wires.forEach(w => { w.gradingColor = null; w.matchedGroup = null; });
        const userGroups = getUserConnectedGroups();
        const ans = DB_ANSWERS[currentLayoutId]; 
        
        let correctTargetCount = 0;
        let correctCommonGroups = 0; // ê·¸ë£¹ ë‹¨ìœ„ ì„±ê³µ ì²´í¬
        let wrongWireCount = 0;

        if(ans) {
            // Target ì±„ì 
            ans.targets.forEach(info => {
                const foundWire = wires.find(w => (w.start.id === info[0] && w.end.id === info[1]) || (w.start.id === info[1] && w.end.id === info[0]));
                if (foundWire) { 
                    foundWire.gradingColor = '#28a745'; 
                    foundWire.matchedGroup = info;
                    correctTargetCount++;
                }
            });

            // Common ì±„ì  (ì§‘í•© ë¹„êµ)
            ans.commons.forEach(commonGroup => {
                const targetSet = new Set(commonGroup.pins);
                const matchedUserGroup = userGroups.find(userSet => {
                    let hasIntersection = false;
                    for (let p of targetSet) { if (userSet.has(p)) { hasIntersection = true; break; } }
                    return hasIntersection;
                });

                if (matchedUserGroup) {
                    const isMissing = !commonGroup.pins.every(p => matchedUserGroup.has(p));
                    const isExtra = matchedUserGroup.size !== targetSet.size;

                    if (!isMissing && !isExtra) {
                        // ì„±ê³µí•œ ê·¸ë£¹
                        correctCommonGroups++;
                        wires.forEach(w => {
                            if (matchedUserGroup.has(w.start.id) && matchedUserGroup.has(w.end.id)) {
                                w.gradingColor = commonGroup.color; w.matchedGroup = commonGroup;
                            }
                        });
                    }
                }
            });
        }
        
        wires.forEach(w => { 
            if (!w.gradingColor) { 
                w.gradingColor = '#ff0000'; 
                wrongWireCount++;
            } 
        });

        if(ans) {
            const totalTargets = ans.targets.length;
            const totalCommons = ans.commons.length;
            
            if (correctTargetCount === totalTargets && correctCommonGroups === totalCommons && wrongWireCount === 0) {
                setTimeout(() => { successModal.style.display = "flex"; }, 300);
            }
        }
    }

    function getUserConnectedGroups() {
        const groups = []; const visited = new Set(); const adj = {};
        allPins.forEach(p => adj[p.id] = []);
        wires.forEach(w => { adj[w.start.id].push(w.end.id); adj[w.end.id].push(w.start.id); });
        allPins.forEach(pin => {
            if (!visited.has(pin.id) && pin.connections > 0) {
                const group = new Set(); const queue = [pin.id]; visited.add(pin.id); group.add(pin.id);
                while(queue.length > 0) {
                    const curr = queue.shift();
                    adj[curr].forEach(neighbor => { if (!visited.has(neighbor)) { visited.add(neighbor); group.add(neighbor); queue.push(neighbor); } });
                }
                groups.push(group);
            }
        });
        return groups;
    }

    function handleInput(clientX, clientY) {
        const rect = canvas.getBoundingClientRect();
        const scaleX = canvas.width / rect.width; const scaleY = canvas.height / rect.height;
        const x = (clientX - rect.left) * scaleX; const y = (clientY - rect.top) * scaleY;
        if (isGradingMode) {
            let clickedPin = null;
            for(let p of allPins) { if (Math.sqrt((x - p.x)**2 + (y - p.y)**2) < 20) { clickedPin = p; break; } }
            if (clickedPin) {
                const wire = wires.find(w => w.start === clickedPin || w.end === clickedPin);
                if (wire && wire.matchedGroup) {
                    focusedGroup = { type: wire.matchedGroup.visuals ? 'common' : 'target', data: wire.matchedGroup };
                    statusMsg.textContent = "ì§‘ì¤‘ ëª¨ë“œ";
                } else {
                    const ans = DB_ANSWERS[currentLayoutId];
                    if (ans) {
                        const common = ans.commons.find(g => g.pins.includes(clickedPin.id));
                        if(common) focusedGroup = { type: 'common', data: common };
                        else {
                            const target = ans.targets.find(t => t[0] === clickedPin.id || t[1] === clickedPin.id);
                            if(target) focusedGroup = { type: 'target', data: target };
                        }
                    }
                }
                draw(); return;
            } else { focusedGroup = null; statusMsg.textContent = "ì±„ì  ì™„ë£Œ"; draw(); return; }
        }
        if (isAdminMode) { } else { if(isGradingMode) return; }
        let clickedPin = null;
        for(let p of allPins) { if (Math.sqrt((x - p.x)**2 + (y - p.y)**2) < 20) { clickedPin = p; break; } }
        if (!clickedPin) { selectedPin = null; statusMsg.textContent = "ì·¨ì†Œ"; draw(); return; }
        if (selectedPin === null) {
            if (clickedPin.connections >= 2) { alert("2ì„  ì´ˆê³¼"); return; }
            selectedPin = clickedPin; statusMsg.textContent = "ëª©í‘œ ì„ íƒ"; statusMsg.style.color = "red"; draw();
        } else {
            if (selectedPin === clickedPin) { selectedPin = null; statusMsg.textContent = "ì·¨ì†Œ"; draw(); return; }
            if (clickedPin.connections >= 2) { alert("ì—°ê²° ë¶ˆê°€"); return; }
            saveHistory();
            wires.push({ start: selectedPin, end: clickedPin, offset: (Math.random() * 30) - 15 });
            selectedPin.connections++; clickedPin.connections++; selectedPin = null; 
            statusMsg.textContent = "ì™„ë£Œ"; statusMsg.style.color = "#007bff"; draw();
        }
    }

    function saveHistory() { historyStack.push(wires.map(w => ({ s: w.start.id, e: w.end.id, o: w.offset }))); if(historyStack.length > 50) historyStack.shift(); }
    function undoLastAction() {
        if(historyStack.length === 0) return statusMsg.innerText = "ì·¨ì†Œí•  ì‘ì—… ì—†ìŒ";
        const prev = historyStack.pop();
        wires = []; allPins.forEach(p => p.connections = 0);
        prev.forEach(item => { const s = allPins.find(p => p.id === item.s); const e = allPins.find(p => p.id === item.e); if(s && e) { wires.push({ start: s, end: e, offset: item.o }); s.connections++; e.connections++; } });
        selectedPin = null; draw();
    }
    function resetWires() { wires = []; historyStack = []; allPins.forEach(p => p.connections = 0); selectedPin = null; isGradingMode = false; focusedGroup = null; if(!isAdminMode) updateUI(); draw(); }
    function toggleGrading() {
        if(isAdminMode) { alert("ê´€ë¦¬ì ëª¨ë“œë¥¼ ë„ì„¸ìš”."); return; }
        if(wires.length === 0) { alert("ê²°ì„  ë‚´ìš© ì—†ìŒ"); return; }
        isGradingMode = !isGradingMode;
        if(isGradingMode) { calculateGrading(); statusMsg.textContent = "ì±„ì  ì™„ë£Œ"; btnCheck.textContent = "í¸ì§‘"; btnCheck.classList.add('active'); } 
        else { updateUI(); }
        draw();
    }
    function updateUI() { btnCheck.classList.remove('active'); statusMsg.textContent = "ëŒ€ê¸° ì¤‘"; btnCheck.textContent = "ì±„ì  í•˜ê¸°"; }
    function clearCurrentLayoutData() {
        if(confirm("í˜„ì¬ ë„ë©´ ì •ë‹µ ì‚­ì œ?")) { DB_ANSWERS[currentLayoutId] = { targets: [], commons: [] }; wires = []; groupIndexInput.value = 1; draw(); showSaveStatus("ì‚­ì œë¨"); }
    }
    function exportAllData() {
        const json = JSON.stringify(DB_ANSWERS, null, 4);
        exportArea.style.display = 'block'; exportArea.value = "let DB_ANSWERS = " + json + ";"; exportArea.select(); document.execCommand('copy'); alert("ë³µì‚¬ë¨");
    }
    function showSaveStatus(msg) { saveStatus.textContent = msg; setTimeout(() => { saveStatus.textContent = ""; }, 3000); }

    init();
</script>
</body>
</html>